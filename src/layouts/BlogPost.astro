---
import Layout from "./Layout.astro";

export interface Props {
  url: string;
  file: string;
  content: {
    title: string;
    description: string;
    pubDate?: string;
    updatedDate?: string;
    heroImage?: string;
    about: boolean;
    wide: boolean;
  };
}

const {
  url,
  file,
  content: { title, description, pubDate, updatedDate, heroImage, about, wide },
} = Astro.props;
---

<Layout title={title} description={description} image={heroImage}>
  <style>
    .title {
      font-size: 2em;
      margin: 0.25em 0 0;
    }
    hr {
      border-top: 1px solid #ddd;
      margin: 1rem 0;
    }
  </style>

  <article>
    {
      heroImage && (
        <a href={heroImage} target="_blank" rel="noopener noreferrer" class="hero-image-link block">
          <img
            transition:name={url}
            class="max-h-[25rem] mx-auto object-scale-down cursor-pointer hover:opacity-80 transition-opacity"
            width={720}
            height={360}
            src={heroImage}
            alt=""
          />
        </a>
      )
    }
    <h1 class="title" transition:name={heroImage ? "" : url}>{title}</h1>
    {pubDate && <time>{pubDate}</time>}
    {
      updatedDate && (
        <div>
          Last updated on <time>{updatedDate}</time>
        </div>
      )
    }
    <br/>
    {description}
    <slot />
  </article>
  {
    !about && (
      <script
        src="https://giscus.app/client.js"
        data-repo="Tricked-dev/tricked.dev"
        data-repo-id="R_kgDOHYCdHg"
        data-category="Blogs"
        data-category-id="DIC_kwDOHYCdHs4CS7Mv"
        data-mapping="title"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="dark"
        data-lang="en"
        data-loading="lazy"
        crossorigin="anonymous"
        async
        id="giscus"
      />
      <a href={`https://github.com/Tricked-dev/tricked.dev/tree/master/src/pages/blog/${file
      .split("/")
      .at(-1)}`}>View on Github</a>
    )
  }
  {wide &&
    <style is:global>
      body {
        --width: 80rem;
      }
    </style>
  }


  <script>
    // Track if giscus is ready
    let giscusReady = false;

    // Giscus theme synchronization
    function syncGiscusTheme() {
      if (!giscusReady) return;

      const theme = document.documentElement.getAttribute('data-theme') || 'dark';
      const giscusTheme = theme === 'light' ? 'light' : 'dark';

      const iframe = document.querySelector('iframe.giscus-frame');
      if (!iframe || !iframe.contentWindow) return;

      iframe.contentWindow.postMessage(
        { giscus: { setConfig: { theme: giscusTheme } } },
        'https://giscus.app'
      );
    }

    // Listen for messages from giscus
    function handleGiscusMessage(event) {
      if (event.origin !== 'https://giscus.app') return;
      if (!(typeof event.data === 'object' && event.data.giscus)) return;


      giscusReady = true;
      syncGiscusTheme();
    }

    window.addEventListener('message', handleGiscusMessage);

    // Listen for theme changes by watching the data-theme attribute on <html>
    const themeObserver = new MutationObserver(() => {
      syncGiscusTheme();
      let themeMap = {
        dark: "ayu-dark",
        black: "aurora-x",
        light: "catppuccin-latte",
      };

      document.documentElement.dataset.extheme = themeMap[document.documentElement.dataset.theme];
    });

    themeObserver.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['data-theme']
    });

    // Image enlargement functionality
    function setupImageModal() {
      // Handle both hero image and all images in article content
      const clickableImages = document.querySelectorAll('.hero-image-link, article img');

      clickableImages.forEach(imageElement => {
        // For hero image link, use the link; for article images, use the image itself
        const targetElement = imageElement.classList.contains('hero-image-link') ? imageElement : imageElement;

        targetElement.style.cursor = 'pointer';

        targetElement.addEventListener('click', (e) => {
          e.preventDefault();
          if(document.querySelector(".image-modal")) return;

          // Get image source - from href for links, src for images
          const imgSrc = imageElement.classList.contains('hero-image-link')
            ? imageElement.getAttribute('href')
            : imageElement.getAttribute('src');

        // Create modal overlay
        const modal = document.createElement('div');
        modal.className = 'image-modal';
        modal.innerHTML = `
          <div class="image-modal-overlay absolute inset-0 bg-black/85 cursor-pointer"></div>
          <div class="image-modal-content relative w-full h-full flex items-center justify-center p-0">
            <button class="image-modal-close absolute top-4 right-4 bg-white/10 hover:bg-white/20 border-0 text-white text-5xl w-12 h-12 rounded-full cursor-pointer flex items-center justify-center leading-none p-0 transition-colors z-10" aria-label="Close">&times;</button>
            <a href="${imgSrc}" target="_blank" rel="noopener noreferrer" class="image-modal-link block leading-none">
              <img src="${imgSrc}" alt="Enlarged view" class="block max-w-[calc(100vw-8rem)] max-h-[calc(100vh-8rem)] w-auto h-auto object-contain shadow-[0_20px_60px_rgba(0,0,0,0.5)] rounded cursor-pointer hover:opacity-90 transition-opacity" />
            </a>
            <div class="image-modal-hint absolute bottom-8 left-1/2 -translate-x-1/2 text-white/80 text-sm bg-black/50 px-4 py-2 rounded pointer-events-none animate-[fadeInHint_0.3s_ease_0.5s_both]">Click image to open in new tab • Click outside to close • Press ESC</div>
          </div>
        `;

        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden';

        // Close on overlay click, close button, or escape key
        const closeModal = () => {
          modal.classList.add('closing');
          setTimeout(() => {
            document.body.removeChild(modal);
            document.body.style.overflow = '';
          }, 200);
        };

        modal.addEventListener('click', (e) => {
          // Close if clicking on the modal itself, overlay, or content area, but not the image link
          if (e.target === modal || e.target.classList.contains('image-modal-overlay') || e.target.classList.contains('image-modal-content')) {
            closeModal();
          }
        });
        modal.querySelector('.image-modal-close').addEventListener('click', closeModal);

        document.addEventListener('keydown', function escHandler(e) {
          if (e.key === 'Escape') {
            closeModal();
            document.removeEventListener('keydown', escHandler);
          }
        });

        // Fade in animation
        setTimeout(() => modal.classList.add('active'), 10);
        });
      });
    }

    // Run on initial load
    setupImageModal();

    // Run on view transitions navigation
    document.addEventListener('astro:page-load', () => {
      setupImageModal();
    });
  </script>

  <style is:global>
    .image-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 10000;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .image-modal.active {
      opacity: 1;
    }

    .image-modal.closing {
      opacity: 0;
    }

    @keyframes fadeInHint {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(0.5rem);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }
  </style>

</Layout>
